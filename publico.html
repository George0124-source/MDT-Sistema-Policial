<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sede Ciudadanos</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">GOBIERNO - CIUDADAN√çA</div>
        <button onclick="location.href='index.html'" class="btn-logout">Acceso Polic√≠a</button>
    </nav>

    <div class="main-container">
        <!-- Pesta√±as -->
        <div style="display:flex; margin-bottom:20px;">
            <button class="tab-btn active" onclick="openTab('ver')">CONSULTAR DNI</button>
            <button class="tab-btn" onclick="openTab('crear')">CREAR DNI</button>
            <button class="tab-btn" onclick="openTab('reclamar')" style="background:#c0392b">PERD√ç MI DNI</button>
        </div>

        <!-- Pesta√±a VER -->
        <div id="tab-ver" class="tab-content active">
            <div class="panel">
                <h3>VER MI DNI</h3>
                <input type="text" id="verDNIInput" placeholder="Tu DNI exacto...">
                <button class="btn-blue" onclick="window.buscarDNI()">BUSCAR</button>
                <div id="resultadoDNI"></div>
            </div>
        </div>

        <!-- Pesta√±a CREAR -->
        <div id="tab-crear" class="tab-content">
            <div class="panel">
                <h3>NUEVO REGISTRO</h3>
                <input type="text" id="newNombre" placeholder="Nombre y Apellidos">
                <input type="text" id="newDNI" placeholder="DNI Deseado">
                <input type="date" id="newNac">
                <input type="text" id="newFoto" placeholder="URL Foto (Imgur/Discord)">
                <select id="newGen"><option value="H">Hombre</option><option value="M">Mujer</option></select>
                <button class="btn-login" style="background:var(--success)" onclick="window.guardarDNI()">REGISTRARSE</button>
            </div>
        </div>

        <!-- Pesta√±a RECLAMAR -->
        <div id="tab-reclamar" class="tab-content">
            <div class="panel">
                <h3 style="color:#c0392b">REPORTAR DNI PERDIDO</h3>
                <input type="text" id="recNombre" placeholder="Tu Nombre">
                <textarea id="recMotivo" placeholder="Motivo (CK, Robo, Error...)"></textarea>
                <button class="btn-login" style="background:#e67e22" onclick="window.enviarReporte()">ENVIAR A STAFF</button>
            </div>
        </div>
    </div>

    <!-- Cargamos config -->
    <script src="config.js"></script>

    <!-- SCRIPT TIPO MODULE PARA FIREBASE -->
    <script type="module">
        import { db, collection, addDoc, getDocs, query, where } from './firebase.js';

        // --- TRUCO PARA QUE FUNCIONEN LOS BOTONES ---
        
        // 1. Pesta√±as
        window.openTab = function(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+id).style.display = 'block';
        }

        // 2. Guardar DNI
        window.guardarDNI = async function() {
            const nombre = document.getElementById('newNombre').value;
            const dni = document.getElementById('newDNI').value;
            const foto = document.getElementById('newFoto').value;
            const nac = document.getElementById('newNac').value;
            const gen = document.getElementById('newGen').value;

            if(!nombre || !dni) return alert("Faltan datos.");

            const q = query(collection(db, "ciudadanos"), where("dni", "==", dni));
            const snap = await getDocs(q);
            if(!snap.empty) return alert("¬°Ese DNI ya est√° cogido!");

            try {
                await addDoc(collection(db, "ciudadanos"), { nombre, dni, foto, nac, gen });
                alert("‚úÖ DNI Creado Correctamente");
                location.reload();
            } catch(e) { console.error(e); alert("Error de base de datos. Revisa firebase.js"); }
        }

        // 3. Buscar DNI
        window.buscarDNI = async function() {
            const dni = document.getElementById('verDNIInput').value;
            if(!dni) return;
            const q = query(collection(db, "ciudadanos"), where("dni", "==", dni));
            const snap = await getDocs(q);
            
            const div = document.getElementById('resultadoDNI');
            div.innerHTML = "";
            
            if(snap.empty) {
                div.innerHTML = "<p>No encontrado.</p>";
            } else {
                snap.forEach(doc => {
                    const d = doc.data();
                    div.innerHTML = `
                        <div class="dni-card-visual">
                            <img src="${d.foto || ''}" class="dni-photo">
                            <div>
                                <h3>${d.nombre}</h3>
                                <p><strong>DNI:</strong> ${d.dni}</p>
                                <p>Nacimiento: ${d.nac}</p>
                                <p>G√©nero: ${d.gen}</p>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // 4. Reporte (Webhook)
        window.enviarReporte = function() {
            const nom = document.getElementById('recNombre').value;
            const mot = document.getElementById('recMotivo').value;
            if(!nom) return alert("Pon tu nombre.");
            
            if(!WEBHOOK_STAFF || WEBHOOK_STAFF.includes("PEGA_")) return alert("Configura la Webhook de Staff en config.js");

            const embed = { title:"üö® DNI PERDIDO", color:15158332, fields:[{name:"Nombre",value:nom},{name:"Motivo",value:mot}] };
            fetch(WEBHOOK_STAFF, {
                method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({embeds:[embed]})
            }).then(() => alert("Aviso enviado.")).catch(() => alert("Error enviando."));
        }
    </script>
</body>
</html>
