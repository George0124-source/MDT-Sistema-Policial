<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sede Electr√≥nica - Ciudadanos</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilos espec√≠ficos para la zona p√∫blica */
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; background: #333; border: none; color: white; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .tab-btn.active { background: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        
        .dni-card-visual {
            background: linear-gradient(135deg, #e0e0e0 0%, #ffffff 100%);
            color: #000; padding: 20px; border-radius: 10px; border: 1px solid #999;
            display: flex; gap: 20px; max-width: 450px; margin: 20px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative;
        }
        .dni-photo { width: 100px; height: 120px; background: #ccc; object-fit: cover; border: 1px solid #000; }
        .dni-details h3 { margin: 0 0 10px 0; color: #002D62; border-bottom: 2px solid #c0392b; display: inline-block; }
        .dni-details p { margin: 5px 0; font-size: 14px; }
        .watermark { position: absolute; top: 10px; right: 10px; opacity: 0.1; font-size: 50px; color: #000; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="navbar" style="background: #2c3e50;">
        <div class="nav-brand"><i class="fas fa-landmark"></i> GOBIERNO DE ESPA√ëA</div>
        <!-- Bot√≥n para ir al login de polic√≠a -->
        <button onclick="location.href='index.html'" class="btn-logout" style="background: #333;">Soy Polic√≠a</button>
    </nav>

    <div class="main-container" style="display: block; max-width: 800px; margin: 0 auto;">
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('ver')"><i class="fas fa-search"></i> CONSULTAR DNI</button>
            <button class="tab-btn" onclick="switchTab('crear')"><i class="fas fa-plus-circle"></i> NUEVO REGISTRO</button>
            <button class="tab-btn" onclick="switchTab('reclamar')" style="background: #c0392b;"><i class="fas fa-exclamation-triangle"></i> PERD√ç MI DNI</button>
        </div>

        <!-- PESTA√ëA 1: VER DNI -->
        <div id="tab-ver" class="tab-content active">
            <div class="panel">
                <h3 style="text-align:center;">CONSULTA DE DOCUMENTACI√ìN</h3>
                <p style="text-align:center; color:#888;">Introduce tu n√∫mero de DNI para visualizarlo.</p>
                <div class="search-box">
                    <input type="text" id="inputBuscarDNI" placeholder="Introduzca su DNI (Ej: 12345678X)">
                    <button onclick="buscarMiDNI()" class="btn-blue" style="width: auto; padding: 0 20px;">VER</button>
                </div>
                <div id="resultadoDNI" style="display:none;"></div>
            </div>
        </div>

        <!-- PESTA√ëA 2: CREAR DNI -->
        <div id="tab-crear" class="tab-content">
            <div class="panel">
                <h3><i class="fas fa-user-edit"></i> REGISTRO CIVIL</h3>
                <div class="input-group">
                    <label>Nombre Completo (IC):</label>
                    <input type="text" id="nuevoNombre">
                </div>
                <div class="input-group">
                    <label>DNI Deseado:</label>
                    <input type="text" id="nuevoDNI" placeholder="Elige tu n√∫mero">
                </div>
                <div class="input-group">
                    <label>Fecha Nacimiento:</label>
                    <input type="date" id="nuevoNac">
                </div>
                <div class="input-group">
                    <label>URL Foto (Discord/Imgur):</label>
                    <input type="text" id="nuevoFoto">
                </div>
                <div class="input-group">
                    <label>G√©nero:</label>
                    <select id="nuevoGen" style="width:100%; padding:10px; background:#333; color:white;">
                        <option value="H">Hombre</option>
                        <option value="M">Mujer</option>
                    </select>
                </div>
                <button id="btnCrear" class="btn-login" style="background: var(--success); margin-top: 15px;">REGISTRAR CIUDADANO</button>
            </div>
        </div>

        <!-- PESTA√ëA 3: RECLAMAR / RESTABLECER -->
        <div id="tab-reclamar" class="tab-content">
            <div class="panel" style="border: 1px solid #c0392b;">
                <h3 style="color: #c0392b;"><i class="fas fa-bell"></i> SOLICITUD DE RESTABLECIMIENTO</h3>
                <p style="font-size: 13px; color: #aaa;">
                    Use esto solo si ha perdido su DNI, se lo han robado o hay un error. 
                    Esto enviar√° un aviso a los <strong>Administradores (Staff)</strong>. Ellos revisar√°n el caso.
                    <strong>NO SE BORRAR√Å AUTOM√ÅTICAMENTE</strong> para evitar fraudes.
                </p>

                <div class="input-group">
                    <label>Nombre del Personaje:</label>
                    <input type="text" id="reclamaNombre">
                </div>
                <div class="input-group">
                    <label>DNI Perdido (Si lo recuerdas):</label>
                    <input type="text" id="reclamaDNI">
                </div>
                <div class="input-group">
                    <label>Motivo de la solicitud:</label>
                    <textarea id="reclamaMotivo" placeholder="Ej: CK, error en el nombre, robo de identidad..." style="width:100%; height:80px; background:#333; color:white; border:none; padding:10px;"></textarea>
                </div>
                <button onclick="enviarReclamacion()" class="btn-login" style="background: #e67e22;">ENVIAR SOLICITUD A STAFF</button>
            </div>
        </div>

    </div>

    <script src="config.js"></script>
    <!-- Script Modular para Firebase -->
    <script type="module">
        import { db, collection, addDoc, getDocs, query, where } from './firebase.js';

        // Hacer las funciones globales para los botones HTML
        window.switchTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // --- 1. FUNCI√ìN VER DNI ---
        window.buscarMiDNI = async function() {
            const dni = document.getElementById('inputBuscarDNI').value;
            if(!dni) return alert("Escribe un DNI.");

            const q = query(collection(db, "ciudadanos"), where("dni", "==", dni));
            const snapshot = await getDocs(q);

            if(snapshot.empty) {
                alert("‚ùå DNI no encontrado. ¬øEst√° bien escrito?");
                document.getElementById('resultadoDNI').style.display = 'none';
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const html = `
                        <div class="dni-card-visual">
                            <i class="fas fa-crown watermark"></i>
                            <img src="${data.foto || 'https://i.imgur.com/v0k4a45.png'}" class="dni-photo">
                            <div class="dni-details">
                                <h3>DOCUMENTO NACIONAL</h3>
                                <p><strong>NOMBRE:</strong> ${data.nombre}</p>
                                <p><strong>DNI:</strong> <span style="color:#c0392b; font-weight:bold;">${data.dni}</span></p>
                                <p><strong>NACIMIENTO:</strong> ${data.nacimiento}</p>
                                <p><strong>G√âNERO:</strong> ${data.genero === 'H' ? 'Hombre' : 'Mujer'}</p>
                                <p style="font-size:10px; margin-top:10px;">MINISTERIO DEL INTERIOR</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('resultadoDNI').innerHTML = html;
                    document.getElementById('resultadoDNI').style.display = 'block';
                });
            }
        }

        // --- 2. FUNCI√ìN CREAR DNI ---
        document.getElementById('btnCrear').addEventListener('click', async () => {
            const nombre = document.getElementById('nuevoNombre').value;
            const dni = document.getElementById('nuevoDNI').value;
            const foto = document.getElementById('nuevoFoto').value;
            const nac = document.getElementById('nuevoNac').value;
            const gen = document.getElementById('nuevoGen').value;

            if(!nombre || !dni) return alert("Nombre y DNI son obligatorios.");

            // Comprobar si ya existe
            const q = query(collection(db, "ciudadanos"), where("dni", "==", dni));
            const check = await getDocs(q);
            
            if(!check.empty) {
                return alert("‚ö†Ô∏è ESE DNI YA EXISTE. Elige otro n√∫mero.");
            }

            try {
                await addDoc(collection(db, "ciudadanos"), {
                    nombre: nombre, dni: dni, nacimiento: nac, foto: foto, genero: gen
                });
                alert("‚úÖ ¬°Registro Completado! Ya tienes tu DNI.");
                location.reload();
            } catch (e) {
                alert("Error al guardar.");
            }
        });

        // --- 3. FUNCI√ìN RECLAMAR DNI (WEBHOOK) ---
        window.enviarReclamacion = function() {
            const nombre = document.getElementById('reclamaNombre').value;
            const dni = document.getElementById('reclamaDNI').value;
            const motivo = document.getElementById('reclamaMotivo').value;

            if(!nombre || !motivo) return alert("Rellena el nombre y el motivo.");
            if(WEBHOOK_STAFF.includes("PEGA_AQUI")) return alert("Error: Configura la Webhook de Staff.");

            const embed = {
                title: "üö® SOLICITUD DE RESTABLECIMIENTO DE DNI",
                color: 15158332, // Rojo
                description: "Un ciudadano solicita ayuda con su documentaci√≥n.",
                fields: [
                    { name: "üë§ Nombre PJ", value: nombre, inline: true },
                    { name: "üÜî DNI Afectado", value: dni || "Desconocido", inline: true },
                    { name: "üìù Motivo / Problema", value: motivo }
                ],
                footer: { text: "Panel de Reclamaciones - Esperando acci√≥n de Staff" },
                timestamp: new Date()
            };

            fetch(WEBHOOK_STAFF, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ embeds: [embed] })
            }).then(res => {
                if(res.ok) {
                    alert("‚úÖ Solicitud enviada a los Administradores.\nEspera a que te contacten o revisen el caso.");
                    document.getElementById('reclamaMotivo').value = "";
                } else {
                    alert("Error al enviar.");
                }
            });
        }
    </script>
</body>
</html>
