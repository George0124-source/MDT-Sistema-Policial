<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MDT - Sistema Central</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">MDT POLICIAL</div>
        <div class="nav-user">
            <span id="infoOficial" style="margin-right:10px; font-size:14px; color:#ccc;"></span>
            <button onclick="window.logout()" class="btn-logout">Salir</button>
        </div>
    </nav>

    <div class="main-container">
        
        <!-- COLUMNA IZQUIERDA: LEYES -->
        <div class="panel left">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar artículo o ley...">
            </div>
            <div id="articlesList" class="list-container">
                <!-- Se rellena con JS -->
            </div>
        </div>

        <!-- COLUMNA DERECHA: PROCESAMIENTO -->
        <div class="panel right">
            
            <!-- SECCIÓN 1: BUSCAR ANTECEDENTES (Firebase) -->
            <div class="history-section">
                <h4 style="margin-top:0; color:var(--accent)"><i class="fas fa-history"></i> BUSCAR ANTECEDENTES</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="searchHistoryID" placeholder="ID Discord del Ciudadano" style="margin:0;">
                    <button onclick="window.buscarAntecedentes()" class="btn-blue" style="width:auto;"><i class="fas fa-search"></i></button>
                </div>
                <div id="historyResults" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
            </div>

            <!-- SECCIÓN 2: CALCULADORA -->
            <div class="report-header">
                <h4 style="margin:0; color:var(--text-main)"><i class="fas fa-calculator"></i> NUEVO REPORTE</h4>
            </div>
            
            <div id="summaryList" class="summary-list"></div>

            <div class="report-footer">
                <div class="total-row"><span>MULTA:</span> <span id="totalFine" class="amount">0€</span></div>
                <div class="total-row"><span>CÁRCEL:</span> <span id="totalJail" class="jail-time">0m</span></div>
                
                <div class="input-group">
                    <input type="text" id="detenidoInput" placeholder="Nombre del Detenido">
                    <input type="text" id="discordDetenidoInput" placeholder="ID Discord (OBLIGATORIO PARA GUARDAR HISTORIAL)">
                    <textarea id="detallesInput" placeholder="Detalles del suceso..."></textarea>
                </div>

                <div class="action-buttons">
                    <button onclick="window.clearAll()" class="btn btn-red">Limpiar</button>
                    <button onclick="window.copyReport()" class="btn btn-blue">Copiar</button>
                </div>
                <div class="action-buttons">
                    <button onclick="window.enviarInforme('multa')" class="btn btn-yellow">MULTA</button>
                    <button onclick="window.enviarInforme('arresto')" class="btn btn-orange">ARRESTO</button>
                    <button onclick="window.enviarInforme('denuncia')" class="btn btn-purple">DENUNCIA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cargamos configuración -->
    <script src="config.js"></script>

    <!-- SCRIPT PRINCIPAL TIPO MODULE -->
    <script type="module">
        import { db, collection, addDoc, getDocs, query, where, orderBy } from './firebase.js';

        // --- CÓDIGO PENAL COMPLETO ---
        // Pego aquí el array para asegurar que no falte nada
        // ==========================================
// BASE DE DATOS DEL CÓDIGO PENAL (COMPLETO)
// ==========================================

const codigoPenal = [
    // --- TÍTULO I: CORRUPCIÓN ---
    { id: "1.1", titulo: "Mal uso del Código Penal", multa: 10000, meses: 1 },
    { id: "1.2", titulo: "Corrupto en el Cuerpo de Seguridad", multa: 20000, meses: 24 }, // 2 años
    { id: "1.3", titulo: "Corrupto dentro del Cuerpo de Juez", multa: 30000, meses: 36 }, // 3 años
    { id: "1.4", titulo: "Corrupto dentro del Cuerpo de Abogado", multa: 25000, meses: 36 },
    { id: "1.5", titulo: "Arresto sin motivo", multa: 15000, meses: 12 },

    // --- TÍTULO II: AGRESIONES Y HOMICIDIOS ---
    { id: "2.1", titulo: "Agresión hacia un civil", multa: 1000, meses: 1 },
    { id: "2.2", titulo: "Agresión hacia un Funcionario Público", multa: 1500, meses: 3 },
    { id: "2.3", titulo: "Homicidio hacia un civil", multa: 10000, meses: 60 }, // 5 años
    { id: "2.4", titulo: "Homicidio hacia un Funcionario Público", multa: 65000, meses: 240 }, // 20 años
    { id: "2.5", titulo: "Varios homicidios civiles (Por cada uno)", multa: 15000, meses: 180 }, // 15 años
    { id: "2.6", titulo: "Varios homicidios Funcionarios (Por cada uno)", multa: 20000, meses: 240 }, // 20 años
    { id: "2.7", titulo: "Tortura", multa: 5000, meses: 12 },
    { id: "2.8", titulo: "Amenaza con arma de fuego (Civil)", multa: 7000, meses: 3 },
    { id: "2.9", titulo: "Amenaza con arma blanca (Civil)", multa: 5000, meses: 2 },
    { id: "2.10", titulo: "Amenaza con arma de fuego (Funcionario)", multa: 10000, meses: 5 },
    { id: "2.11", titulo: "Amenaza con arma blanca (Funcionario)", multa: 8500, meses: 2 },
    { id: "2.12", titulo: "Amenaza verbal (Civil)", multa: 500, meses: 0.25 }, // 1 semana
    { id: "2.13", titulo: "Amenaza verbal (Funcionario)", multa: 5000, meses: 0.5 }, // 2 semanas
    { id: "2.14", titulo: "Intento de agresión a un civil", multa: 500, meses: 0.25 },
    { id: "2.15", titulo: "Intento de secuestro a un civil", multa: 16000, meses: 12 },
    { id: "2.16", titulo: "Secuestro a un civil", multa: 20000, meses: 36 },
    { id: "2.17", titulo: "Intento agresión a Funcionario", multa: 10000, meses: 1 },
    { id: "2.18", titulo: "Intento secuestro a Funcionario", multa: 20000, meses: 17 }, // 1 año y 5 meses
    { id: "2.19", titulo: "Secuestro a un Funcionario", multa: 30000, meses: 60 },
    { id: "2.20", titulo: "Intento homicidio a Funcionario", multa: 50000, meses: 60 },
    { id: "2.21", titulo: "Tortura Grave", multa: 15000, meses: 60 },
    { id: "2.22", titulo: "Alteración del orden público", multa: 1000, meses: 0 },
    { id: "2.23", titulo: "Racismo", multa: 3000, meses: 0 },
    { id: "2.24", titulo: "Faltas de respeto a civil", multa: 500, meses: 0 },
    { id: "2.25", titulo: "Faltas de respeto a Funcionario", multa: 1000, meses: 0 },
    { id: "2.31", titulo: "Circular sin camiseta", multa: 100, meses: 0 },
    { id: "2.32", titulo: "Acoso sexual", multa: 3000, meses: 24 },
    { id: "2.33", titulo: "Negarse a identificarse", multa: 1000, meses: 0.25 },
    { id: "2.34", titulo: "Obstrucción a la justicia", multa: 1000, meses: 0 },
    { id: "2.35", titulo: "Llevar máscara sin motivo", multa: 500, meses: 0 },
    { id: "2.36", titulo: "Manifestación ilegal", multa: 10000, meses: 0 }, // Media estimada
    { id: "2.37", titulo: "Acoso o intimidación", multa: 1300, meses: 0 },
    { id: "2.38", titulo: "Incitación al odio/violencia", multa: 2000, meses: 0 },
    { id: "2.39", titulo: "Delito de Estafa", multa: 3000, meses: 0 },
    { id: "2.40", titulo: "No llevar documentación", multa: 5000, meses: 0 },
    { id: "2.41", titulo: "Vacilar a cuerpos de la ley", multa: 1000, meses: 0 },
    { id: "2.42", titulo: "Desorden público", multa: 800, meses: 0 },
    { id: "2.43", titulo: "Robo secreto de estado", multa: 0, meses: 999 }, // Perpetua
    { id: "2.44", titulo: "Atentado a la autoridad", multa: 10000, meses: 60 },
    { id: "2.45", titulo: "Intento rebelión / Golpe Estado", multa: 100000, meses: 999 }, // Permanente
    { id: "2.46", titulo: "Atentado Terrorista", multa: 500000, meses: 999 }, // Perpetua
    { id: "2.47", titulo: "Fraude electoral", multa: 50000, meses: 36 },

    // --- ROBOS Y ASALTOS (Dentro de Título II) ---
    { id: "2.49", titulo: "Robo con intimidación a civil", multa: 3500, meses: 3 },
    { id: "2.50", titulo: "Robo con violencia a civil", multa: 4500, meses: 6 },
    { id: "2.51", titulo: "Robo Menor (Gasolinera/ATM)", multa: 15000, meses: 36 },
    { id: "2.52", titulo: "Robo Medio (Armería/Tool/Casa)", multa: 40000, meses: 180 },
    { id: "2.53", titulo: "Robo Joyería", multa: 100000, meses: 600 }, // 50 años
    { id: "2.54", titulo: "Robo Mayor (Banco)", multa: 500000, meses: 999 }, // Perpetua
    { id: "2.55", titulo: "Allanamiento propiedad privada", multa: 5500, meses: 36 },

    // --- TÍTULO III: TRÁFICO (Sección 1) ---
    { id: "3.1.1", titulo: "Exceso velocidad (+40km/h)", multa: 100, meses: 0 },
    { id: "3.1.2", titulo: "Exceso velocidad (+60km/h)", multa: 200, meses: 0 },
    { id: "3.1.3", titulo: "Exceso velocidad (+80km/h)", multa: 400, meses: 0 },
    { id: "3.1.4", titulo: "Exceso velocidad (+100km/h)", multa: 500, meses: 1 },
    { id: "3.1.5", titulo: "Exceso velocidad (+120km/h)", multa: 600, meses: 1 },
    { id: "3.1.6", titulo: "Conducción temeraria", multa: 500, meses: 0 },
    { id: "3.1.7", titulo: "Conductor en mal estado", multa: 1000, meses: 0 },
    { id: "3.1.8", titulo: "Accidente sin heridos", multa: 3000, meses: 0 },
    { id: "3.1.9", titulo: "Accidente con heridos", multa: 5000, meses: 0 },
    { id: "3.1.10", titulo: "Provocar accidente grave", multa: 10000, meses: 0.25 }, // 1 sem
    { id: "3.1.11", titulo: "Sin cinturón abrochado", multa: 200, meses: 0 },
    { id: "3.1.12", titulo: "Estacionar lugar no permitido", multa: 200, meses: 0 },
    { id: "3.1.13", titulo: "Estacionar indebidamente", multa: 100, meses: 0 },
    { id: "3.1.14", titulo: "Ignorar señales tráfico", multa: 500, meses: 0 },
    { id: "3.1.15", titulo: "Saltarse semáforo rojo", multa: 200, meses: 0 },
    { id: "3.1.16", titulo: "Uso excesivo claxon", multa: 150, meses: 0 },
    { id: "3.1.17", titulo: "Giro indebido", multa: 150, meses: 0 },
    { id: "3.1.18", titulo: "Circular sentido contrario", multa: 200, meses: 0 },
    { id: "3.1.19", titulo: "No ceder paso emergencias", multa: 1000, meses: 0 },
    { id: "3.1.20", titulo: "Adelantamiento indebido", multa: 300, meses: 0 },
    { id: "3.1.21", titulo: "Circular marcha atrás", multa: 500, meses: 0 },
    { id: "3.1.22", titulo: "Saltarse control de tráfico", multa: 3000, meses: 5 },
    { id: "3.1.23", titulo: "Vehículo malas condiciones", multa: 200, meses: 0 },
    { id: "3.1.24", titulo: "Conducir bajo drogas/alcohol", multa: 1000, meses: 1 },
    { id: "3.1.25", titulo: "Negarse prueba alcohol/drogas", multa: 2000, meses: 2 },
    { id: "3.1.26", titulo: "No colocar faros de noche", multa: 100, meses: 0 },
    { id: "3.1.27", titulo: "Sin intermitentes al girar", multa: 50, meses: 0 },
    { id: "3.1.28", titulo: "Sin intermitentes al aparcar", multa: 100, meses: 0 },
    { id: "3.1.29", titulo: "Vehículo pesado en puente", multa: 1000, meses: 0 },
    { id: "3.1.30", titulo: "Negarse inspección vehículo", multa: 1000, meses: 0 },
    { id: "3.1.31", titulo: "Modificaciones ilegales", multa: 500, meses: 0 },
    { id: "3.1.32", titulo: "Tractor por vía pública", multa: 500, meses: 0 },
    { id: "3.1.33", titulo: "Iniciar persecución", multa: 1000, meses: 12 },

    // --- TÍTULO III: CARNETS (Sección 2) ---
    { id: "3.2.1", titulo: "Conducir sin Carnet", multa: 5000, meses: 5 },
    { id: "3.2.2", titulo: "Conducir sin Carnet encima", multa: 500, meses: 0 }, // 1 dia
    { id: "3.2.3", titulo: "Conducir sin Carnet Tipo B", multa: 1000, meses: 1 },
    { id: "3.2.4", titulo: "Conducir sin Carnet Tipo C1", multa: 5000, meses: 12 },
    { id: "3.2.5", titulo: "Conducir sin Carnet Tipo C", multa: 8000, meses: 12 },
    { id: "3.2.6", titulo: "Conducir sin Carnet Tipo CE", multa: 10000, meses: 12 },

    // --- TÍTULO III: CARRERAS (Sección 3) ---
    { id: "3.3.1", titulo: "Organizar carrera ilegal", multa: 10000, meses: 36 },
    { id: "3.3.2", titulo: "Herido en carrera ilegal", multa: 10000, meses: 60 },
    { id: "3.3.3", titulo: "Homicidio en carrera ilegal", multa: 20000, meses: 120 },
    { id: "3.3.4", titulo: "Participar en carrera ilegal", multa: 5000, meses: 0 },

    // --- TÍTULO IV: VENTA DE ARMAS (Sección 1) ---
    { id: "4.1.1", titulo: "Venta ilegal navaja", multa: 300, meses: 0 },
    { id: "4.1.2", titulo: "Venta ilegal Beretta M9", multa: 12000, meses: 1 },
    { id: "4.1.3", titulo: "Venta ilegal Colt M1911", multa: 12500, meses: 1 },
    { id: "4.1.4", titulo: "Venta ilegal Remington 870", multa: 15000, meses: 3 },
    { id: "4.1.5", titulo: "Venta ilegal AK-47", multa: 55000, meses: 12 },
    { id: "4.1.6", titulo: "Venta ilegal Colt TEC-9", multa: 26500, meses: 1 },
    { id: "4.1.7", titulo: "Venta ilegal Skorpion", multa: 4500, meses: 1 },
    { id: "4.1.8", titulo: "Venta ilegal PPSH-41", multa: 31500, meses: 1 },
    { id: "4.1.9", titulo: "Venta ilegal Desert Eagle", multa: 18000, meses: 2 },
    { id: "4.1.10", titulo: "Venta ilegal Kriss Vector", multa: 29500, meses: 1 },
    { id: "4.1.11", titulo: "Venta ilegal Python Colt", multa: 24500, meses: 2 },
    { id: "4.1.12", titulo: "Venta ilegal LMT L129A1", multa: 18500, meses: 2 },
    { id: "4.1.13", titulo: "Venta ilegal Remington MSR", multa: 48000, meses: 4 },
    { id: "4.1.14", titulo: "Venta ilegal M249", multa: 55000, meses: 9 },
    { id: "4.1.15", titulo: "Venta ilegal M14", multa: 20000, meses: 2 },

    // --- TÍTULO IV: USO DE ARMAS (Sección 2) ---
    { id: "4.2.1", titulo: "Portar Beretta M9 (sin lic)", multa: 5000, meses: 0 },
    { id: "4.2.2", titulo: "Portar Colt M1911 (sin lic)", multa: 5500, meses: 0 },
    { id: "4.2.3", titulo: "Portar Kriss Vector (sin lic)", multa: 17000, meses: 0 },
    { id: "4.2.4", titulo: "Portar AK-47", multa: 49000, meses: 24 },
    { id: "4.2.5", titulo: "Portar M249", multa: 53000, meses: 36 },
    { id: "4.2.6", titulo: "Portar Desert Eagle", multa: 17000, meses: 12 },
    { id: "4.2.7", titulo: "Portar Remington MSR", multa: 30000, meses: 24 },
    { id: "4.2.8", titulo: "Portar TEC-9", multa: 19000, meses: 36 },
    { id: "4.2.9", titulo: "Portar Python Colt (sin lic)", multa: 9000, meses: 0 },
    { id: "4.2.10", titulo: "Portar M14 (sin lic)", multa: 14500, meses: 0 },
    { id: "4.2.11", titulo: "Portar Remington 870 (sin lic)", multa: 14000, meses: 0 },
    { id: "4.2.13", titulo: "Portar LMT L129A1 (sin lic)", multa: 15000, meses: 0 },
    { id: "4.2.14", titulo: "Portar Skorpion (sin lic)", multa: 12000, meses: 0 },
    { id: "4.2.15", titulo: "Portar PPSH-41 (sin lic)", multa: 20000, meses: 0 },

    // --- TÍTULO V: CONTRA ADMINISTRACIÓN ---
    { id: "5.1", titulo: "Desacato a la ley", multa: 500, meses: 0 },
    { id: "5.2", titulo: "Resistirse al arresto", multa: 300, meses: 0 },
    { id: "5.4", titulo: "Falso testimonio", multa: 1000, meses: 0 },

    // --- TÍTULO VI: ALERTAS DEFCON ---
    { id: "6.1.2", titulo: "Salir en DEFCON roja con arma", multa: 10000, meses: 0 },
    { id: "6.1.3", titulo: "Salir en DEFCON antiterrorista", multa: 20000, meses: 1 },

    // --- TÍTULO VII: CIBERNÉTICOS ---
    { id: "7.1", titulo: "Ciber amenazas de muerte", multa: 3000, meses: 1 },
    { id: "7.2", titulo: "Sexting ilegal", multa: 2500, meses: 12 },
    { id: "7.3", titulo: "Enviar img sin consentimiento", multa: 3000, meses: 0 },
    { id: "7.4", titulo: "Ciberbullying", multa: 1500, meses: 0 },
    { id: "7.5", titulo: "Acoso Cibernético", multa: 3000, meses: 0 },

    // --- TÍTULO IX: PROTECCIÓN DATOS ---
    { id: "9.1", titulo: "Grabar policía sin permiso", multa: 2500, meses: 0 }
];

        let selected = [];

        // --- INICIALIZACIÓN ---
        const user = JSON.parse(sessionStorage.getItem('oficialLogueado'));
        if (!user) window.location.href = 'index.html';
        document.getElementById('infoOficial').textContent = `${user.rango} ${user.placa}`;

        renderList(codigoPenal);

        // Buscador
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filt = codigoPenal.filter(x => x.titulo.toLowerCase().includes(val) || x.id.includes(val));
            renderList(filt);
        });

        // --- FUNCIONES VISUALES ---
        function renderList(arr) {
            const div = document.getElementById('articlesList');
            div.innerHTML = "";
            arr.forEach(art => {
                let t = art.meses > 0 ? (art.meses >= 12 ? (art.meses/12).toFixed(1)+"a" : art.meses+"m") : "";
                if(art.meses>=900) t="PERP";
                const el = document.createElement('div');
                el.className = 'article-item';
                el.innerHTML = `<div><strong style="color:var(--accent)">[${art.id}]</strong> ${art.titulo} <small style="color:#777">${t}</small></div><div class="price-tag">${art.multa}€</div>`;
                el.onclick = () => { selected.push(art); update(); };
                div.appendChild(el);
            });
        }

        function update() {
            const div = document.getElementById('summaryList');
            div.innerHTML = "";
            let f = 0, j = 0;
            if(selected.length===0) div.innerHTML = "<p style='text-align:center;color:#666'>Lista vacía</p>";
            
            selected.forEach((s, i) => {
                f += s.multa; j += s.meses;
                const el = document.createElement('div');
                el.className = 'summary-item';
                el.innerHTML = `<span>${s.titulo}</span><span onclick="window.del(${i})" style="color:var(--danger);cursor:pointer">✕</span>`;
                div.appendChild(el);
            });

            document.getElementById('totalFine').innerText = f + "€";
            let tText = j + " Meses";
            if(j >= 12) tText = (j/12).toFixed(1) + " Años";
            if(j >= 900) tText = "PERPETUA";
            document.getElementById('totalJail').innerText = tText;
        }

        // --- FUNCIONES GLOBALES (ACCESIBLES DESDE HTML) ---
        
        window.del = (i) => { selected.splice(i, 1); update(); };
        
        window.clearAll = () => { 
            selected = []; 
            document.getElementById('detenidoInput').value = "";
            document.getElementById('discordDetenidoInput').value = "";
            document.getElementById('detallesInput').value = "";
            update(); 
        };

        window.logout = () => { sessionStorage.removeItem('oficialLogueado'); window.location.href = 'index.html'; };

        window.copyReport = () => {
            if(selected.length===0) return alert("Nada que copiar.");
            let txt = "**INFORME**\n";
            selected.forEach(s => txt += `• ${s.titulo} (${s.multa}€)\n`);
            txt += `TOTAL: ${document.getElementById('totalFine').innerText} | ${document.getElementById('totalJail').innerText}`;
            navigator.clipboard.writeText(txt);
            alert("Copiado");
        };

        // --- 1. FUNCIÓN BUSCAR ANTECEDENTES (FIREBASE) ---
        window.buscarAntecedentes = async () => {
            const id = document.getElementById('searchHistoryID').value;
            if(!id) return alert("Introduce un ID de Discord para buscar.");

            const resDiv = document.getElementById('historyResults');
            resDiv.innerHTML = "Buscando...";

            try {
                // Buscamos en la colección 'historial_criminal' donde 'detenido_id' sea igual al input
                const q = query(collection(db, "historial_criminal"), where("detenido_id", "==", id), orderBy("fecha", "desc"));
                const querySnapshot = await getDocs(q);

                resDiv.innerHTML = "";
                if(querySnapshot.empty) {
                    resDiv.innerHTML = "<p style='color:#ccc'>No tiene antecedentes registrados.</p>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = new Date(data.fecha).toLocaleDateString();
                    // Creamos el HTML de cada antecedente
                    resDiv.innerHTML += `
                        <div class="history-result">
                            <strong style="color:var(--danger)">${data.tipo.toUpperCase()}</strong> - ${date}<br>
                            <span style="color:#aaa">Oficial: ${data.oficial}</span><br>
                            <em>${data.cargos_resumen}</em>
                        </div>
                    `;
                });

            } catch(e) {
                console.error(e);
                resDiv.innerHTML = "Error al buscar (necesitas crear el índice en Firebase o claves mal puestas).";
            }
        };


        // --- 2. FUNCIÓN ENVIAR (DISCORD + FIREBASE) ---
        window.enviarInforme = async (tipo) => {
            const nombre = document.getElementById('detenidoInput').value;
            const idDiscord = document.getElementById('discordDetenidoInput').value;
            const detalles = document.getElementById('detallesInput').value;

            if(!nombre) return alert("Pon el nombre del detenido.");
            if(selected.length===0) return alert("Selecciona delitos.");

            // 1. Enviar a Discord
            let url = "";
            let color = 0;
            if(tipo==='multa') { url=WEBHOOK_MULTAS; color=15844367; }
            if(tipo==='arresto') { url=WEBHOOK_ARRESTOS; color=15105570; }
            if(tipo==='denuncia') { url=WEBHOOK_DENUNCIAS; color=10181046; }

            if(url.includes("PEGA_")) return alert("Configura Webhooks.");

            let desc = selected.map(s => `• ${s.titulo}`).join("\n");
            let oficial = JSON.parse(sessionStorage.getItem('oficialLogueado'));
            
            let oficialTxt = `${oficial.rango} ${oficial.placa}`;
            if(oficial.discordId) oficialTxt += ` <@${oficial.discordId}>`;
            
            let detenidoTxt = `**${nombre}**`;
            if(idDiscord) detenidoTxt += ` <@${idDiscord}>`;

            const embed = {
                title: "NUEVO REPORTE: " + tipo.toUpperCase(),
                color: color,
                fields: [
                    { name: "Oficial", value: oficialTxt, inline: true },
                    { name: "Ciudadano", value: detenidoTxt, inline: true },
                    { name: "Cargos", value: desc },
                    { name: "Total", value: document.getElementById('totalFine').innerText + " | " + document.getElementById('totalJail').innerText }
                ],
                timestamp: new Date()
            };
            if(detalles) embed.fields.push({ name: "Detalles", value: detalles });

            // Enviar Discord
            fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({embeds:[embed]}) });

            // 2. GUARDAR EN FIREBASE (SI HAY ID DE DISCORD)
            if(idDiscord) {
                try {
                    await addDoc(collection(db, "historial_criminal"), {
                        detenido_nombre: nombre,
                        detenido_id: idDiscord,
                        oficial: `${oficial.rango} ${oficial.placa}`,
                        tipo: tipo,
                        cargos_resumen: selected.map(s => s.titulo).join(", "),
                        multa_total: document.getElementById('totalFine').innerText,
                        pena_total: document.getElementById('totalJail').innerText,
                        detalles: detalles,
                        fecha: new Date().toISOString()
                    });
                    alert(`✅ Enviado a Discord y guardado en Historial de ID: ${idDiscord}`);
                } catch(e) {
                    console.error(e);
                    alert("Enviado a Discord, pero ERROR al guardar en Firebase (Revisa firebase.js)");
                }
            } else {
                alert("✅ Enviado a Discord. (NO SE GUARDÓ EN HISTORIAL PORQUE NO PUSISTE ID)");
            }

            window.clearAll();
        };

    </script>
</body>
</html>

