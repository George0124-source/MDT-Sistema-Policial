<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDT - Sistema Central</title>
    <link rel="stylesheet" href="style.css?v=4.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">MDT POLICIAL</div>
        <div class="nav-user">
            <span id="infoOficial" style="margin-right:10px; font-size:14px; color:#ccc;">Agente</span>
            <button onclick="window.logout()" class="btn-logout">Salir</button>
        </div>
    </nav>

    <div class="main-container">
        
        <!-- COLUMNA IZQUIERDA: LEYES -->
        <div class="panel left">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar artículo o ley...">
                <i class="fas fa-search"></i>
            </div>
            <div id="articlesList" class="list-container">
                <!-- Se rellena automáticamente -->
            </div>
        </div>

        <!-- COLUMNA DERECHA: PROCESAMIENTO -->
        <div class="panel right">
            
            <!-- SECCIÓN 1: BUSCAR ANTECEDENTES -->
            <div class="history-section">
                <h4 style="margin-top:0; color:var(--accent)"><i class="fas fa-history"></i> BUSCAR ANTECEDENTES</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="searchHistoryID" placeholder="ID Discord del Ciudadano" style="margin:0;">
                    <button onclick="window.buscarAntecedentes()" class="btn-blue" style="width:auto;"><i class="fas fa-search"></i></button>
                </div>
                <div id="historyResults" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
            </div>

            <!-- SECCIÓN 2: CALCULADORA -->
            <div class="report-header">
                <h4 style="margin:0; color:var(--text-main)"><i class="fas fa-calculator"></i> NUEVO REPORTE</h4>
            </div>
            
            <div id="summaryList" class="summary-list">
                <p style="text-align:center; color:#666;">Selecciona artículos de la izquierda.</p>
            </div>

            <div class="report-footer">
                <div class="total-row"><span>MULTA:</span> <span id="totalFine" class="amount">0€</span></div>
                <div class="total-row"><span>CÁRCEL:</span> <span id="totalJail" class="jail-time">0m</span></div>
                
                <div class="input-group">
                    <input type="text" id="detenidoInput" placeholder="Nombre del Detenido">
                    <input type="text" id="discordDetenidoInput" placeholder="ID Discord (OBLIGATORIO PARA HISTORIAL)">
                    <textarea id="detallesInput" placeholder="Detalles del suceso..."></textarea>
                </div>

                <div class="action-buttons">
                    <button onclick="window.clearAll()" class="btn btn-red">Limpiar</button>
                    <button onclick="window.copyReport()" class="btn btn-blue">Copiar</button>
                </div>
                <div class="action-buttons">
                    <button onclick="window.enviarInforme('multa')" class="btn btn-yellow">MULTA</button>
                    <button onclick="window.enviarInforme('arresto')" class="btn btn-orange">ARRESTO</button>
                    <button onclick="window.enviarInforme('denuncia')" class="btn btn-purple">DENUNCIA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cargamos configuración -->
    <script src="config.js?v=4.0"></script>

    <!-- SCRIPT TODO EN UNO (Lógica + Leyes + Firebase) -->
    <script type="module">
        import { db, collection, addDoc, getDocs, query, where, orderBy } from './firebase.js';

        // --- 1. BASE DE DATOS DE LEYES (INTEGRADA AQUÍ MISMO) ---
        const codigoPenal = [
            // CAP I
            { id: "1.0", titulo: "No tener DNI/NIE registrado", multa: 1500, meses: 0 },
            { id: "1.0.1", titulo: "No llevar DNI/NIE o Carnet", multa: 250, meses: 0 },
            { id: "1.0.2", titulo: "Conducción sin Carnet", multa: 1750, meses: 0 },
            { id: "1.0.3", titulo: "Conducción sin seguro", multa: 1750, meses: 0 },
            { id: "1.0.4", titulo: "Carnet caducado", multa: 1250, meses: 0 },
            { id: "1.0.5", titulo: "Seguro caducado", multa: 1250, meses: 0 },
            { id: "1.1", titulo: "Abuso del claxon", multa: 45, meses: 0 },
            { id: "1.2", titulo: "Pisar línea continua", multa: 65, meses: 0 },
            { id: "1.2.1", titulo: "Adelantamiento línea continua", multa: 100, meses: 0 },
            { id: "1.2.2", titulo: "Giro indebido", multa: 95, meses: 0 },
            { id: "1.3", titulo: "Sentido contrario", multa: 150, meses: 0 },
            { id: "1.4", titulo: "Estacionamiento prohibido", multa: 50, meses: 0 },
            { id: "1.4.1", titulo: "Estacionamiento doble fila", multa: 75, meses: 0 },
            { id: "1.5", titulo: "Obstruir circulación", multa: 175, meses: 0 },
            { id: "1.6", titulo: "Saltarse señal parada", multa: 75, meses: 0 },
            { id: "1.7", titulo: "No ceder emergencias", multa: 850, meses: 0 },
            { id: "1.8", titulo: "Marcha atrás peligrosa", multa: 125, meses: 0 },
            { id: "1.9", titulo: "Evadir control", multa: 600, meses: 0 },
            { id: "1.9.1", titulo: "Fuga de control", multa: 1350, meses: 0 },
            { id: "1.10", titulo: "Exceso vel. (Urbana)", multa: 750, meses: 0 },
            { id: "1.10.1", titulo: "Exceso vel. (Interurbana)", multa: 650, meses: 0 },
            { id: "1.10.2", titulo: "Exceso vel. (Autovía)", multa: 500, meses: 0 },
            { id: "1.11", titulo: "Vehículo fallos", multa: 350, meses: 0 },
            { id: "1.12", titulo: "Sin luces noche", multa: 150, meses: 0 },
            { id: "1.13", titulo: "Sin luces túnel", multa: 75, meses: 0 },
            { id: "1.13.1", titulo: "Luces largas túnel", multa: 25, meses: 0 },
            { id: "1.14", titulo: "Zona restringida (Vehículo)", multa: 300, meses: 0 },
            { id: "1.15", titulo: "Conducción estupefacientes", multa: 1500, meses: 3 },
            { id: "1.15.1", titulo: "Conducción alcohol", multa: 1250, meses: 3 },
            { id: "1.16.1", titulo: "Siniestro (2 imp)", multa: 250, meses: 0 },
            { id: "1.16.2", titulo: "Siniestro múltiple", multa: 500, meses: 0 },
            { id: "1.17", titulo: "Provocar al volante", multa: 950, meses: 0 },
            { id: "1.18", titulo: "Dañar mobiliario público", multa: 1050, meses: 0 },
            { id: "1.18.1", titulo: "Dañar mobiliario privado", multa: 1500, meses: 0 },
            { id: "1.19", titulo: "Intento atropello civil", multa: 1700, meses: 0 },
            { id: "1.19.1", titulo: "Intento atropello civil fuga", multa: 7000, meses: 0 },
            { id: "1.20", titulo: "Intento atropello func.", multa: 2000, meses: 0 },
            { id: "1.20.1", titulo: "Intento atropello func. fuga", multa: 10000, meses: 0 },
            { id: "1.21", titulo: "Atropello civil", multa: 5000, meses: 0 },
            { id: "1.21.1", titulo: "Atropello civil fuga", multa: 7500, meses: 12 },
            { id: "1.22", titulo: "Atropello funcionario", multa: 7500, meses: 15 },
            { id: "1.22.1", titulo: "Atropello func. fuga", multa: 10000, meses: 15 },
            { id: "1.23", titulo: "Crear carrera ilegal", multa: 50000, meses: 6 },
            { id: "1.23.1", titulo: "Participar carrera", multa: 25000, meses: 1 },
            { id: "1.24", titulo: "Sin cinturón", multa: 500, meses: 0 },
            { id: "1.25", titulo: "Persona maletero", multa: 2500, meses: 0 },
            { id: "1.26", titulo: "Iniciar persecución policial", multa: 7000, meses: 0 },
            { id: "1.27", titulo: "Iniciar persecución", multa: 2000, meses: 0 },
            { id: "1.28", titulo: "Tirar objetos ventanilla", multa: 750, meses: 0 },
            { id: "1.29", titulo: "Sin matrícula", multa: 1000, meses: 0 },
            { id: "1.29.1", titulo: "Matrícula no registrada", multa: 250, meses: 0 },
            { id: "1.29.2", titulo: "Matrícula tapada", multa: 750, meses: 0 },
            { id: "1.30", titulo: "Alterar taxímetro", multa: 1500, meses: 0 },
            { id: "1.31", titulo: "Niño solo en coche", multa: 3000, meses: 0 },
            { id: "1.32", titulo: "No usar intermitentes", multa: 200, meses: 0 },
            { id: "1.32.1", titulo: "Uso indebido intermitentes", multa: 600, meses: 0 },
            { id: "1.33", titulo: "Móvil al volante", multa: 3500, meses: 0 },
            { id: "1.34", titulo: "Conducir menor", multa: 650, meses: 0 },
            { id: "1.35", titulo: "Distancia seguridad", multa: 450, meses: 0 },
            { id: "1.36", titulo: "Conducción temeraria", multa: 2000, meses: 0 },
            { id: "1.37", titulo: "Música alta", multa: 350, meses: 0 },
            { id: "1.38", titulo: "Posesión ilícitos coche", multa: 1500, meses: 0 },
            { id: "1.39", titulo: "Transporte inflamable mal", multa: 650, meses: 0 },
            { id: "1.39.1", titulo: "Transporte inflamable sin per.", multa: 1500, meses: 0 },
            { id: "1.40", titulo: "Uso indebido aeronave", multa: 15000, meses: 12 },

            // CAP II
            { id: "2.0", titulo: "Hurto civil", multa: 500, meses: 0 },
            { id: "2.0.1", titulo: "Hurto civil (Arma blanca)", multa: 1000, meses: 24 },
            { id: "2.0.2", titulo: "Hurto civil (Arma fuego)", multa: 1500, meses: 36 },
            { id: "2.1", titulo: "Hurto funcionario", multa: 1000, meses: 0 },
            { id: "2.1.1", titulo: "Hurto func. (Arma blanca)", multa: 1500, meses: 24 },
            { id: "2.1.2", titulo: "Hurto func. (Arma fuego)", multa: 2500, meses: 36 },
            { id: "2.2", titulo: "Robo civil", multa: 1000, meses: 0 },
            { id: "2.2.1", titulo: "Robo civil (Arma blanca)", multa: 1500, meses: 24 },
            { id: "2.2.2", titulo: "Robo civil (Arma fuego)", multa: 2000, meses: 36 },
            { id: "2.3", titulo: "Robo funcionario", multa: 2000, meses: 0 },
            { id: "2.3.1", titulo: "Robo func. (Arma blanca)", multa: 2500, meses: 24 },
            { id: "2.3.2", titulo: "Robo func. (Arma fuego)", multa: 3500, meses: 36 },
            { id: "2.4", titulo: "Allanamiento morada", multa: 2500, meses: 3 },
            { id: "2.4.1", titulo: "Allanamiento armado", multa: 3500, meses: 6 },
            { id: "2.5", titulo: "Robo local", multa: 5500, meses: 48 },
            { id: "2.5.1", titulo: "Robo local armado", multa: 6500, meses: 72 },
            { id: "2.6", titulo: "Robo Joyería", multa: 45000, meses: 180 },
            { id: "2.6.1", titulo: "Robo Joyería armado", multa: 50000, meses: 204 },
            { id: "2.7", titulo: "Robo Banco", multa: 250000, meses: 264 },
            { id: "2.7.1", titulo: "Robo Banco armado", multa: 500000, meses: 300 },
            { id: "2.8", titulo: "Robo vehículo", multa: 2500, meses: 6 },
            { id: "2.8.1", titulo: "Robo vehículo armado", multa: 5000, meses: 12 },
            { id: "2.9", titulo: "Apropiación cosa perdida", multa: 100, meses: 0 },
            { id: "2.9.1", titulo: "Apropiación ilegal", multa: 1000, meses: 0 },
            { id: "2.10", titulo: "Robo estatal", multa: 25000000, meses: 999 },
            { id: "2.10.1", titulo: "Robo estatal armado", multa: 30000000, meses: 999 },
            { id: "2.11", titulo: "Hurto uso público", multa: 500, meses: 0 },
            { id: "2.11.1", titulo: "Hurto público armado", multa: 750, meses: 0 },
            { id: "2.12", titulo: "Robo uso público", multa: 750, meses: 0 },
            { id: "2.12.1", titulo: "Robo público armado", multa: 900, meses: 0 },
            { id: "2.13", titulo: "Hurto uso privado", multa: 1000, meses: 0 },
            { id: "2.13.1", titulo: "Hurto privado armado", multa: 1250, meses: 0 },
            { id: "2.14", titulo: "Robo uso privado", multa: 750, meses: 0 },
            { id: "2.14.1", titulo: "Robo privado armado", multa: 900, meses: 0 },
            { id: "2.15", titulo: "Ocupación ilegal", multa: 500, meses: 0 },

            // CAP III
            { id: "3.0", titulo: "Insultos orientación sexual", multa: 1750, meses: 0 },
            { id: "3.1", titulo: "Insultos racistas", multa: 1000, meses: 0 },
            { id: "3.2", titulo: "Violencia género", multa: 450, meses: 3 },
            { id: "3.3", titulo: "Intento agresión", multa: 650, meses: 0 },
            { id: "3.4", titulo: "Agresión", multa: 750, meses: 0 },
            { id: "3.5", titulo: "Agresión funcionario", multa: 1000, meses: 0 },
            { id: "3.6", titulo: "Alteración orden público", multa: 1450, meses: 0 },
            { id: "3.7", titulo: "Acoso", multa: 2500, meses: 6 },
            { id: "3.8", titulo: "Intento violación", multa: 5000, meses: 12 },
            { id: "3.8.1", titulo: "Violación", multa: 15000, meses: 60 },
            { id: "3.9", titulo: "Suplantación identidad", multa: 1725, meses: 3 },
            { id: "3.9.1", titulo: "Suplantación culpar", multa: 4750, meses: 12 },
            { id: "3.10", titulo: "Tráfico personas", multa: 16000, meses: 24 },
            { id: "3.10.1", titulo: "Trata blancas", multa: 38000, meses: 48 },
            { id: "3.11", titulo: "Maltrato", multa: 3275, meses: 0 },
            { id: "3.12", titulo: "Intento agresión menor", multa: 1000, meses: 0 },
            { id: "3.13", titulo: "Agresión menor", multa: 3500, meses: 15 },
            { id: "3.8-M", titulo: "Intento violación menor", multa: 15000, meses: 48 },
            { id: "3.8.1-M", titulo: "Violación menor", multa: 55000, meses: 84 },
            { id: "3.9-P", titulo: "Prostitución pública", multa: 3500, meses: 12 },
            { id: "3.9.1-P", titulo: "Prostitución local", multa: 8125, meses: 36 },
            { id: "3.10-D", titulo: "Disturbios calle", multa: 1000, meses: 0 },
            { id: "3.10.1-D", titulo: "Disturbios local", multa: 5000, meses: 2 },
            { id: "3.11-C", titulo: "Comercio ilegal", multa: 1000, meses: 4 },
            { id: "3.12-A", titulo: "Alentar delito", multa: 1500, meses: 24 },
            { id: "3.13-V", titulo: "Conducta violenta", multa: 225, meses: 0 },
            { id: "3.14", titulo: "Creación org. peligrosa", multa: 250000, meses: 999 },
            { id: "3.14.3", titulo: "Pertenecer org. peligrosa", multa: 25000, meses: 264 },
            { id: "3.15", titulo: "Manifestación ilegal", multa: 1250, meses: 0 },
            { id: "3.16", titulo: "Exhibicionismo", multa: 850, meses: 0 },
            { id: "3.17", titulo: "Enmascarado sin motivo", multa: 50, meses: 0 },
            { id: "3.17.1", titulo: "Enmascarado delinquir", multa: 750, meses: 0 },
            { id: "3.18", titulo: "Suplantación funcionario", multa: 5675, meses: 3 },
            { id: "3.19", titulo: "Insultos funcionario", multa: 750, meses: 0 },
            { id: "3.20", titulo: "Contaminar", multa: 1500, meses: 2 },
            { id: "3.21", titulo: "Zona restringida", multa: 750, meses: 0 },
            { id: "3.22", titulo: "Falsa alarma", multa: 12750, meses: 0 },
            { id: "3.23", titulo: "Chaleco antibalas ilegal", multa: 1250, meses: 0 },

            // CAP IV
            { id: "4.0", titulo: "Posesión arma ilegal", multa: 500, meses: 1 },
            { id: "4.0.1", titulo: "Arma sin licencia", multa: 1350, meses: 3 },
            { id: "4.1", titulo: "Uso indebido arma sin lic", multa: 6500, meses: 12 },
            { id: "4.1.1", titulo: "Uso indebido arma", multa: 7500, meses: 15 },
            { id: "4.2", titulo: "Armas contrabando", multa: 10000, meses: 36 },
            { id: "4.2.1", titulo: "Contrabando armas", multa: 250575, meses: 60 },
            { id: "4.3", titulo: "Iniciar tiroteo", multa: 55675, meses: 48 },
            { id: "4.4", titulo: "Disturbio con arma", multa: 1250, meses: 4 },
            { id: "4.5", titulo: "Posesión drogas", multa: 5000, meses: 24 },
            { id: "4.5.2", titulo: "Contrabando drogas", multa: 50000, meses: 120 },
            { id: "4.5.3", titulo: "Compra drogas", multa: 15000, meses: 24 },
            { id: "4.5.4", titulo: "Consumo drogas", multa: 1500, meses: 12 },
            { id: "4.6", titulo: "Alcohol calle", multa: 400, meses: 0 },

            // CAP V
            { id: "5.0", titulo: "Intento homicidio civil", multa: 25000, meses: 48 },
            { id: "5.1", titulo: "Intento homicidio func.", multa: 35000, meses: 60 },
            { id: "5.2", titulo: "Homicidio civil", multa: 75000, meses: 180 },
            { id: "5.2.2", titulo: "Homicidio civil (Arma fuego)", multa: 100000, meses: 204 },
            { id: "5.3", titulo: "Intento homicidio animal", multa: 15000, meses: 20 },
            { id: "5.4", titulo: "Secuestro civil", multa: 3500, meses: 20 },
            { id: "5.5", titulo: "Secuestro menor", multa: 3700, meses: 36 },
            { id: "5.6", titulo: "Secuestro funcionario", multa: 7000, meses: 48 },
            { id: "5.9", titulo: "Amenaza condicional", multa: 10000, meses: 4 },
            { id: "5.10", titulo: "Amenaza incondicional", multa: 1000, meses: 4 },
            { id: "5.12", titulo: "Extorsión persona", multa: 2000, meses: 4 },
            { id: "5.13", titulo: "Extorsión negocio", multa: 5200, meses: 6 },
            { id: "5.14", titulo: "Extorsión funcionario", multa: 5900, meses: 6 },
            { id: "5.15", titulo: "Extorsión juez", multa: 18500, meses: 24 },
            { id: "5.16", titulo: "Falso testimonio", multa: 6000, meses: 24 },
            { id: "5.17", titulo: "Manipulación documentos", multa: 2500, meses: 24 },

            // CAP VI
            { id: "6.0", titulo: "Abuso menores ciber", multa: 2000, meses: 6 },
            { id: "6.1", titulo: "Acoso cibernético", multa: 500, meses: 1 },
            { id: "6.1.3", titulo: "Amenazas cibernéticas", multa: 2000, meses: 3 },
            { id: "6.1.5", titulo: "Sexting", multa: 3000, meses: 3 },
            { id: "6.2", titulo: "Phishing", multa: 2000, meses: 3 },
            { id: "6.3", titulo: "Malware", multa: 1000, meses: 5 }
        ];

        // --- 2. LÓGICA DE LA PÁGINA ---
        let selected = [];

        // Inicialización
        const user = JSON.parse(sessionStorage.getItem('oficialLogueado'));
        if (!user) window.location.href = 'index.html';
        document.getElementById('infoOficial').textContent = `${user.rango} ${user.placa}`;

        renderList(codigoPenal);

        // Evento Buscador
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filt = codigoPenal.filter(x => 
                x.titulo.toLowerCase().includes(val) || x.id.includes(val)
            );
            renderList(filt);
        });

        // Funciones del Sistema
        function renderList(arr) {
            const div = document.getElementById('articlesList');
            div.innerHTML = "";
            arr.forEach(art => {
                let t = art.meses > 0 ? (art.meses >= 12 ? (art.meses/12).toFixed(1)+"a" : art.meses+"m") : "";
                if(art.meses>=900) t="PERP";
                const el = document.createElement('div');
                el.className = 'article-item';
                el.innerHTML = `<div><strong style="color:var(--accent)">[${art.id}]</strong> ${art.titulo} <small style="color:#777">${t}</small></div><div class="price-tag">${art.multa}€</div>`;
                el.onclick = () => { selected.push(art); update(); };
                div.appendChild(el);
            });
        }

        function update() {
            const div = document.getElementById('summaryList');
            div.innerHTML = "";
            let f = 0, j = 0;
            
            if(selected.length===0) div.innerHTML = "<p style='text-align:center;color:#666'>Lista vacía</p>";
            
            selected.forEach((s, i) => {
                f += s.multa; j += s.meses;
                const el = document.createElement('div');
                el.className = 'summary-item';
                el.innerHTML = `<span>${s.titulo}</span><span onclick="window.del(${i})" style="color:var(--danger);cursor:pointer">✕</span>`;
                div.appendChild(el);
            });

            document.getElementById('totalFine').innerText = f + "€";
            let tText = j + " Meses";
            if(j >= 12) tText = (j/12).toFixed(1) + " Años";
            if(j >= 900) tText = "PERPETUA";
            document.getElementById('totalJail').innerText = tText;
        }

        // FUNCIONES GLOBALES
        window.del = (i) => { selected.splice(i, 1); update(); };
        
        window.clearAll = () => { 
            selected = []; 
            document.getElementById('detenidoInput').value = "";
            document.getElementById('discordDetenidoInput').value = "";
            document.getElementById('detallesInput').value = "";
            update(); 
        };

        window.logout = () => { sessionStorage.removeItem('oficialLogueado'); window.location.href = 'index.html'; };

        window.copyReport = () => {
            if(selected.length===0) return alert("Nada que copiar.");
            let txt = "**INFORME**\n";
            selected.forEach(s => txt += `• ${s.titulo} (${s.multa}€)\n`);
            txt += `TOTAL: ${document.getElementById('totalFine').innerText} | ${document.getElementById('totalJail').innerText}`;
            navigator.clipboard.writeText(txt);
            alert("Copiado");
        };

        // --- BUSCAR ANTECEDENTES ---
        window.buscarAntecedentes = async () => {
            const id = document.getElementById('searchHistoryID').value;
            if(!id) return alert("Pon un ID de Discord.");
            const resDiv = document.getElementById('historyResults');
            resDiv.innerHTML = "Buscando...";
            
            try {
                const q = query(collection(db, "historial_criminal"), where("detenido_id", "==", id), orderBy("fecha", "desc"));
                const snap = await getDocs(q);
                resDiv.innerHTML = "";
                if(snap.empty) { resDiv.innerHTML = "<p style='color:#ccc'>Limpio.</p>"; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const f = new Date(d.fecha).toLocaleDateString();
                    resDiv.innerHTML += `<div style="background:#222;padding:5px;margin:5px;border-left:2px solid orange;font-size:12px;"><strong>${d.tipo.toUpperCase()}</strong> - ${f}<br>${d.cargos_resumen}</div>`;
                });
            } catch(e) { console.error(e); resDiv.innerHTML = "Error al buscar."; }
        };

        // --- ENVIAR INFORME ---
        window.enviarInforme = async (tipo) => {
            const nom = document.getElementById('detenidoInput').value;
            const id = document.getElementById('discordDetenidoInput').value;
            const det = document.getElementById('detallesInput').value;

            if(!nom) return alert("Falta nombre.");
            if(selected.length===0) return alert("Falta cargos.");

            let url = "";
            let color = 0;
            if(tipo==='multa') { url=WEBHOOK_MULTAS; color=15844367; }
            if(tipo==='arresto') { url=WEBHOOK_ARRESTOS; color=15105570; }
            if(tipo==='denuncia') { url=WEBHOOK_DENUNCIAS; color=10181046; }

            if(url.includes("PEGA_")) return alert("Configura Webhooks en config.js");

            const oficial = JSON.parse(sessionStorage.getItem('oficialLogueado'));
            let ofiTxt = `${oficial.rango} ${oficial.placa}`;
            if(oficial.discordId) ofiTxt += ` <@${oficial.discordId}>`;
            
            let detTxt = `**${nom}**`;
            if(id) detTxt += ` <@${id}>`;

            const embed = {
                title: "NUEVO REPORTE: "+tipo.toUpperCase(),
                color: color,
                fields: [
                    { name: "Oficial", value: ofiTxt, inline: true },
                    { name: "Ciudadano", value: detTxt, inline: true },
                    { name: "Cargos", value: selected.map(s=>`• ${s.titulo}`).join("\n") },
                    { name: "Total", value: document.getElementById('totalFine').innerText+" | "+document.getElementById('totalJail').innerText }
                ],
                timestamp: new Date()
            };
            if(det) embed.fields.push({name:"Detalles", value:det});

            fetch(url, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({embeds:[embed]})});

            if(id) {
                try {
                    await addDoc(collection(db, "historial_criminal"), {
                        detenido_nombre: nom, detenido_id: id, oficial: `${oficial.rango} ${oficial.placa}`,
                        tipo: tipo, cargos_resumen: selected.map(s=>s.titulo).join(", "),
                        multa_total: document.getElementById('totalFine').innerText,
                        pena_total: document.getElementById('totalJail').innerText,
                        detalles: det, fecha: new Date().toISOString()
                    });
                    alert("✅ Registrado y Guardado.");
                } catch(e) { console.error(e); alert("Registrado en Discord, pero error en Firebase."); }
            } else {
                alert("✅ Registrado en Discord (Sin historial por falta de ID).");
            }
            window.clearAll();
        };
    </script>
</body>
</html>
