<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asuntos Internos - ACCESO RESTRINGIDO</title>
    <!-- Fuentes y Estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --panel-dark: #141414;
            --border-color: #333;
            --admin-red: #e74c3c;
            --admin-dark-red: #922b21;
            --text-gray: #b0b0b0;
            --highlight: #f39c12;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            overflow-x: hidden;
        }

        /* --- PANTALLA DE BLOQUEO (LOGIN) --- */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        .lock-box {
            text-align: center;
            border: 1px solid var(--admin-red);
            padding: 40px;
            background: linear-gradient(180deg, #1a0505 0%, #000 100%);
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.2);
            border-radius: 5px;
            width: 300px;
        }
        .lock-icon { font-size: 50px; color: var(--admin-red); margin-bottom: 20px; }
        .lock-title { font-family: 'Rajdhani', sans-serif; font-size: 24px; letter-spacing: 2px; color: var(--admin-red); margin-bottom: 20px; text-transform: uppercase; }
        .lock-input {
            width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: var(--admin-red);
            font-family: 'Roboto Mono', monospace; text-align: center; font-size: 18px; letter-spacing: 5px;
            margin-bottom: 20px; outline: none; transition: 0.3s;
        }
        .lock-input:focus { border-color: var(--admin-red); box-shadow: 0 0 10px rgba(231, 76, 60, 0.4); }
        .lock-btn {
            background: var(--admin-red); color: white; border: none; padding: 10px 30px;
            font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s; width: 100%;
        }
        .lock-btn:hover { background: red; box-shadow: 0 0 15px var(--admin-red); }

        /* --- INTERFAZ PRINCIPAL --- */
        #adminInterface { display: none; filter: blur(0); transition: 0.5s; }
        
        .top-bar {
            background: #111; border-bottom: 2px solid var(--admin-red);
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
        }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand-logo { font-size: 24px; color: var(--admin-red); }
        .brand-text h1 { margin: 0; font-family: 'Rajdhani', sans-serif; font-size: 22px; text-transform: uppercase; letter-spacing: 2px; }
        .brand-text p { margin: 0; font-size: 10px; color: #666; letter-spacing: 1px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Barra de Herramientas */
        .toolbar {
            display: flex; gap: 20px; margin-bottom: 30px;
            background: var(--panel-dark); padding: 20px; border-radius: 5px;
            border: 1px solid #222; align-items: center; flex-wrap: wrap;
        }
        .search-wrapper { flex: 1; position: relative; }
        .search-wrapper i { position: absolute; left: 15px; top: 12px; color: #666; }
        .search-input {
            width: 100%; padding: 10px 10px 10px 40px; background: #000; border: 1px solid #333;
            color: white; border-radius: 4px; font-family: 'Roboto Mono', monospace;
        }
        .stats-badge {
            background: #000; border: 1px solid var(--admin-red); color: var(--admin-red);
            padding: 8px 15px; font-family: 'Roboto Mono', monospace; font-size: 14px;
        }

        /* Grid de Expedientes */
        .records-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;
        }

        .record-card {
            background: var(--panel-dark); border: 1px solid #222; border-left: 4px solid #444;
            padding: 20px; position: relative; transition: 0.3s; overflow: hidden;
        }
        .record-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.5); border-color: #444; }
        
        /* Tipos de tarjeta */
        .type-arresto { border-left-color: var(--highlight); }
        .type-multa { border-left-color: #f1c40f; }
        .type-denuncia { border-left-color: #9b59b6; }
        .type-borrado { border-left-color: var(--admin-red); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .card-id { font-family: 'Roboto Mono', monospace; font-size: 11px; color: #555; }
        .card-date { font-size: 12px; color: #888; }
        
        .card-body h3 { margin: 0 0 5px 0; font-size: 18px; color: white; display: flex; align-items: center; gap: 10px; }
        .discord-tag { font-size: 11px; background: #5865F2; padding: 2px 6px; border-radius: 3px; color: white; font-weight: normal; }
        
        .card-details { margin: 15px 0; font-size: 13px; color: #aaa; line-height: 1.4; background: #0a0a0a; padding: 10px; border-radius: 4px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .detail-label { color: #666; font-size: 11px; text-transform: uppercase; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .officer-info { font-size: 12px; color: #666; display: flex; align-items: center; gap: 5px; }
        
        .btn-delete {
            background: transparent; border: 1px solid var(--admin-red); color: var(--admin-red);
            padding: 5px 15px; font-size: 11px; cursor: pointer; text-transform: uppercase;
            transition: 0.2s; font-weight: bold;
        }
        .btn-delete:hover { background: var(--admin-red); color: white; }

        /* Scrollbar cool */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: var(--admin-red); }

        /* Loader */
        .loader { border: 3px solid #111; border-top: 3px solid var(--admin-red); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- PANTALLA DE BLOQUEO -->
    <div id="lockScreen">
        <div class="lock-box">
            <div class="lock-icon"><i class="fas fa-shield-alt"></i></div>
            <div class="lock-title">ASUNTOS INTERNOS</div>
            <p style="color:#666; font-size:12px; margin-bottom:20px;">ACCESO RESTRINGIDO NIVEL 5</p>
            <form id="authForm">
                <input type="password" id="adminPass" class="lock-input" placeholder="••••" autocomplete="off" autofocus>
                <button type="submit" class="lock-btn">AUTENTICAR</button>
            </form>
            <p id="loginError" style="color:var(--admin-red); font-size:12px; margin-top:10px; display:none;">ACCESO DENEGADO</p>
        </div>
    </div>

    <!-- INTERFAZ ADMINISTRADOR -->
    <div id="adminInterface">
        <div class="top-bar">
            <div class="brand">
                <i class="fas fa-user-secret brand-logo"></i>
                <div class="brand-text">
                    <h1>Administración Federal</h1>
                    <p>CONTROL DE ANTECEDENTES Y REGISTROS</p>
                </div>
            </div>
            <button onclick="location.href='menu.html'" style="background:none; border:none; color:#666; cursor:pointer; font-size:12px;">
                <i class="fas fa-sign-out-alt"></i> SALIR AL MENÚ
            </button>
        </div>

        <div class="container">
            <div class="toolbar">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar por Nombre, ID Discord o Placa del Agente...">
                </div>
                <div class="stats-badge">
                    <i class="fas fa-database"></i> <span id="totalRecords">0</span> EXPEDIENTES
                </div>
                <button onclick="window.cargarDatos()" style="background:#333; border:none; color:white; padding:10px; cursor:pointer;"><i class="fas fa-sync"></i></button>
            </div>

            <div id="recordsContainer" class="records-grid">
                <!-- AQUÍ SE CARGAN LAS TARJETAS -->
            </div>
        </div>
    </div>

    <!-- LÓGICA -->
    <script type="module">
        import { db } from './firebase.js';
        import { collection, getDocs, deleteDoc, doc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- 1. SEGURIDAD (LOGIN) ---
        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('adminPass').value;
            
            // CAMBIA "admin123" POR LA CONTRASEÑA QUE QUIERAS
            if(pass === "Cupula Fundadora Peninsula0124") {
                document.getElementById('lockScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('adminInterface').style.display = 'block';
                    window.cargarDatos();
                }, 500);
            } else {
                const err = document.getElementById('loginError');
                err.style.display = 'block';
                document.getElementById('adminPass').value = '';
                // Efecto shake
                document.querySelector('.lock-box').animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
            }
        });

        // --- 2. CARGAR DATOS ---
        let allRecords = []; // Guardamos copia local para buscar rápido

        window.cargarDatos = async function() {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = '<div class="loader"></div>';
            
            try {
                const q = query(collection(db, "historial_criminal"), orderBy("fecha", "desc"));
                const snapshot = await getDocs(q);
                
                allRecords = [];
                container.innerHTML = "";

                if (snapshot.empty) {
                    container.innerHTML = "<p style='color:#666; grid-column:1/-1; text-align:center;'>NO HAY REGISTROS EN LA BASE DE DATOS</p>";
                    document.getElementById('totalRecords').innerText = "0";
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    allRecords.push({ id, ...data });
                });

                document.getElementById('totalRecords').innerText = allRecords.length;
                renderRecords(allRecords);

            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color:var(--admin-red)">Error de conexión: ${e.message}</p>`;
            }
        }

        // --- 3. RENDERIZAR TARJETAS ---
        function renderRecords(records) {
            const container = document.getElementById('recordsContainer');
            container.innerHTML = "";

            records.forEach(rec => {
                const dateObj = new Date(rec.fecha);
                const fechaStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString().slice(0,5);
                const tipoClass = `type-${rec.tipo || 'multa'}`;
                
                const card = document.createElement('div');
                card.className = `record-card ${tipoClass}`;
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-id">REF: ${rec.id.slice(0,8).toUpperCase()}</span>
                        <span class="card-date">${fechaStr}</span>
                    </div>
                    <div class="card-body">
                        <h3>
                            ${rec.detenido_nombre} 
                            ${rec.detenido_id ? `<span class="discord-tag"><i class="fab fa-discord"></i></span>` : ''}
                        </h3>
                        <div class="card-details">
                            <div class="detail-row">
                                <span class="detail-label">TIPO</span>
                                <strong style="color:white">${rec.tipo.toUpperCase()}</strong>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">SANCIONES</span>
                                <span style="color:#ddd">${rec.cargos_resumen}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">TOTAL</span>
                                <span style="color:var(--highlight)">${rec.multa_total} / ${rec.pena_total}</span>
                            </div>
                            ${rec.detalles ? `<div style="margin-top:5px; border-top:1px solid #222; padding-top:5px; color:#888;">"${rec.detalles}"</div>` : ''}
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="officer-info">
                            <i class="fas fa-user-shield"></i> ${rec.oficial}
                        </div>
                        <button onclick="window.borrarItem('${rec.id}')" class="btn-delete">
                            <i class="fas fa-trash-alt"></i> ELIMINAR
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 4. BUSCADOR EN TIEMPO REAL ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = allRecords.filter(item => 
                item.detenido_nombre.toLowerCase().includes(val) ||
                (item.detenido_id && item.detenido_id.includes(val)) ||
                item.oficial.toLowerCase().includes(val)
            );
            renderRecords(filtered);
        });

        // --- 5. BORRAR ---
        window.borrarItem = async function(id) {
            if(!confirm("⚠️ ¿CONFIRMAR ELIMINACIÓN DE ESTE EXPEDIENTE? \nEsta acción no se puede deshacer.")) return;
            
            try {
                await deleteDoc(doc(db, "historial_criminal", id));
                // Recargar datos
                const card = document.querySelector(`button[onclick="window.borrarItem('${id}')"]`).closest('.record-card');
                card.style.opacity = '0';
                setTimeout(() => {
                    allRecords = allRecords.filter(r => r.id !== id);
                    document.getElementById('totalRecords').innerText = allRecords.length;
                    renderRecords(allRecords);
                }, 300);
            } catch(e) {
                alert("Error al borrar: " + e.message);
            }
        }
    </script>
</body>
</html>
